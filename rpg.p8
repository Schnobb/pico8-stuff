pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
function _init()
 gs={
  debug=true,
  db={},
  windows={}
 }
 
 pl=init_player()
end

function _update60()
 gs.db={}
 handle_input()
 update_player()
end

function _draw()
 cls()
 map()
 draw_player()
 
 for w in all(gs.windows) do
  w:draw()
 end
 
 if gs.debug then
  printdb(8)
 end
end

function handle_input()
 if pl.t_move<1 then
  if btn(⬆️) then
   pl:move(0,-1)
  elseif btn(⬇️) then
   pl:move(0,1)
  elseif btn(⬅️) then
   pl:move(-1,0)
  elseif btn(➡️) then
   pl:move(1,0)
  end
 end
 
 if btnp(🅾️) then
  win(0,60,6,3)
 end
 
 if btnp(❎) then
  if #gs.windows>0 then
   gs.windows[#gs.windows]:close()
  end
 end
end
-->8
-- player

function init_player()
 local pl={
  x=63-8,
  y=63-8,
  dx=0,
  dy=0,
  tx=0,
  ty=0,
  face=vec2(0,1),
  
  t_move=0,
  maxt_move=20,
  
  t_anim=0,
  sprite={
   idle_up=anim({5},1),
   idle_down=anim({1},1),
   idle_left=anim({9},1,true),
   idle_right=anim({9},1),
   move_up=anim({5,6,7,8},10),
   move_down=anim({1,2,3,4},10),
   move_left=anim({9,10},10,true),
   move_right=anim({9,10},10)
  },
  anim_state="idle_down",
  
  change_anim=function(self,state,reset_timer)
   if reset_timer then
    self.t_anim=0
   end
   
   self.anim_state=state
  end,
  
  move=function(self,dx,dy)
   -- moves player [dx,dy] in tiles
   pl.face=vec2(dx,dy):norm()
   pl.dx=dx*8
   pl.dy=dy*8
   pl.t_move=pl.maxt_move
  end
 }
 
 return pl
end

function draw_player()
 local anim_state=pl.anim_state
 local anim=pl.sprite[anim_state]
 local delay=anim.delay
 local frame=(pl.t_anim\delay)%#anim.f
 frame+=1
 local sprite=anim.f[frame]
 
 db(frame)
 db(sprite)
 db(pl.x..","..pl.y)
 
 spr(sprite,pl.x+pl.tx,pl.y+pl.ty,1,1,anim.flpx,anim.flpy)
 pl.t_anim+=1
end

function update_anim_state()
 local state
 
 if pl.t_move>0 then
  state="move_"
 else
  state="idle_"
 end
 
 if pl.face.x<0 then
  state=state.."left"
 elseif pl.face.x>0 then
  state=state.."right"
 elseif pl.face.y<0 then
  state=state.."up"
 elseif pl.face.y>0 then
  state=state.."down"
 end
 
 db(state)
 pl:change_anim(state)
end

function update_player()
 update_anim_state()
 
 if pl.t_move>0 then
  local mv_idx=1-pl.t_move/pl.maxt_move
  pl.tx=mv_idx*pl.dx
  pl.ty=mv_idx*pl.dy
  
  pl.t_move-=1
  if pl.t_move<1 then
   pl.x+=pl.dx
   pl.y+=pl.dy
   pl.dx=0
   pl.dy=0
   pl.tx=0
   pl.ty=0
  end
 end
end
-->8
-- classes
function anim(f,delay,flpx,flpy)
 return {
  f=f,
  delay=delay,
  flpx=flpx or false,
  flpy=flpy or false
 }
end

function win(x,y,w,h)
 local win={
  x=x,
  y=y,
  w=w,
  h=h,
  
  draw=function(self)
   local w,h=self.w,self.h
   local sprite,sx,sy=80,0,0
   
  	for x=0,w-1 do
  	 sx=0
 	  if x>0 and x<w-1 then
 	   sx=1
 	  elseif x>=w-1 then
 	   sx=2
 	  end
 	  
  	 for y=0,h-1 do
  	  sy=0
  	  if y>0 and y<h-1 then
  	   sy=1
  	  elseif y>=h-1 then
  	   sy=2
  	  end
  	  
  	  local sp=sprite+sx+sy*16
  	  spr(sp,self.x+x*8,self.y+y*8)
  	 end
  	end
  end,
  
  close=function(self)
   del(gs.windows,self)
  end
 }
 
 add(gs.windows,win)
 return win
end
-->8
-- utils
-- debug stuff
function db(str)
 add(gs.db,str)
end

function printdb(col)
 cursor(0,0)
 color(col)
 
 for d in all(gs.db) do
  print(d)
 end
end

-- linear algebra stuff
function vec2(x,y)
 return {
  x=x,
  y=y,
  
  len=function(self)
   return sqrt(x^2+y^2)
  end,
  
  norm=function(self)
   local len=self:len()
   self.x/=len
   self.y/=len
   return self
  end
 }
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000088880000888800008888000088880000088880000888800000000000000000000000000000000000000000
00700700008888000088880000888800008888000088880000888800008888000088880000228f1000228f100000000000000000000000000000000000000000
00077000001ff100001ff100001ff100001ff10000222200002222000022220000222200000ffff0000ffff00000000000000000000000000000000000000000
0007700000feef0000feef0000feef0000feef000009900000099f000009900000f9900000009900000099000000000000000000000000000000000000000000
007007000009900000f990000009900000099f0000f99f0000f9900000f99f0000099f0000009f00000f99f00000000000000000000000000000000000000000
0000000000f99f0000099f0000f99f0000f990000005500000005000000550000005000000005500000055000000000000000000000000000000000000000000
00000000000550000000500000055000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333333333333333333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
333333b3333333333333333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33b3b3b3333333333333333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33b3b3333333333333b3333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
333333333333333333b3b3b300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333333333333333b3b300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333333333333333333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333333333333333333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00067067777777777706700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00056056666666666605600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00067dddddddddddddd6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00067111111111111116700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00067111111111111116700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00067dddddddddddddd6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00067111111111111116700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00067111111111111116700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00067dddddddddddddd6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00067111111111111116700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00067111111111111116700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00067dddddddddddddd6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00067111111111111116700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00056111111111111115600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000dddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00067067777777777706700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00056056666666666605600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
4141414141414141414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414041414141414241414141414141404141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141404141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414241424241414141404141414141404141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141424141414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414041414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414140414141414140414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414141414141414141414141414241414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414140414141414041414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141424141414141414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141424141414141414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414141414140414142414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414141414141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
